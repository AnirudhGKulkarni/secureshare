rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserId() {
      return isSignedIn() ? request.auth.uid : null;
    }

    // Assumes each user has a role field in users/{uid}
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(getUserId())).data.role;
    }

    function isSuperAdmin() {
      return isSignedIn() && getUserRole() == 'super_admin';
    }

    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }

    function isAdminOrSuperAdmin() {
      return isAdmin() || isSuperAdmin();
    }

    // --- Users ---

    
    
    match /users/{userId} {
  allow read: if isSignedIn() && (userId == getUserId() || isAdminOrSuperAdmin());
  allow create: if isSignedIn() && request.auth.uid == userId;
  rules_version = '2';

  service cloud.firestore {
    match /databases/{database}/documents {

      // --- Helper functions ---
      function isSignedIn() {
        return request.auth != null;
      }

      function getUserId() {
        return isSignedIn() ? request.auth.uid : null;
      }

      // Attempt to read the user's role from their profile doc. May be null.
      function getUserRole() {
        return get(/databases/$(database)/documents/users/$(getUserId())).data.role;
      }

      function isSuperAdmin() {
        return isSignedIn() && getUserRole() == 'super_admin';
      }

      function isAdmin() {
        return isSignedIn() && getUserRole() == 'admin';
      }

      function isAdminOrSuperAdmin() {
        return isAdmin() || isSuperAdmin();
      }

      // --- Users ---
      // Users can read their own profile. Admins / super_admins can read all.
      // Creation allowed for the authenticated user (signup flow).
      // Updates: admins may update any field; users may update only a small safe set.
      match /users/{userId} {
        allow read: if isSignedIn() && (userId == getUserId() || isAdminOrSuperAdmin());
        allow create: if isSignedIn() && request.auth.uid == userId;

        allow update: if isSignedIn() && (
          // Admins / super_admins can update any field
          isAdminOrSuperAdmin() ||
          // Regular users may only modify a restricted set of keys on their own profile
          (userId == getUserId()
            && request.resource.data.diff(resource.data).changedKeys().hasOnly(['firstName','lastName','company','companyDomain','domain','loginAlerts','passwordUpdatedAt'])
          )
        );

        // Deletion reserved for super_admin only
        allow delete: if isSuperAdmin();
      }

      // --- Payments ---
      // Allow authenticated users to create a payment record for their own UID.
      // Clients cannot modify or delete payment records â€” server/private code should manage them.
      match /payments/{paymentId} {
        allow create: if isSignedIn()
          && request.resource.data.userId == getUserId()
          && request.resource.data.amount is number
          && request.resource.data.plan is string
          && request.resource.data.createdAt is timestamp;

        allow read: if isSignedIn() && (resource.data.userId == getUserId() || isAdminOrSuperAdmin());

        // Prevent client-side updates/deletes to payment records
        allow update, delete: if false;
      }

      // --- Approval documents (if used) ---
      match /approval_documents/{docId} {
        allow create: if isSignedIn();
        allow read, update, delete: if isAdminOrSuperAdmin();
      }

      // --- Audit logs (login bar chart & recent activity) ---
      match /audit_logs/{logId} {
        // Any signed-in user can create log entries (e.g., LOGIN events)
        allow create: if isSignedIn();

        // Users can read their own logs; admins/super_admins can read all
        allow read: if isSignedIn() && (
          resource.data.userId == getUserId() || isAdminOrSuperAdmin()
        );

        // Prevent client from updating/deleting logs
        allow update, delete: if false;
      }

      // --- Alerts (dashboard alerts section) ---
      match /alerts/{alertId} {
        // Creating alerts
        allow create: if isSignedIn();

        // Reading alerts: owner, global, or admin
        allow read: if isSignedIn() && (
          resource.data.userId == getUserId() ||
          resource.data.userId == 'all' ||
          isAdminOrSuperAdmin()
        );

        // Admins manage alerts
        allow update, delete: if isAdminOrSuperAdmin();
      }

      // --- Policies (Policies page) ---
      match /policies/{policyId} {
        allow read: if true;              // anyone can read policies
        allow create, update, delete: if isAdminOrSuperAdmin();
      }

      // --- Shared data (File Sensitivity pie chart) ---
      match /shared_data/{docId} {
        // Anyone signed in can create a shared_data record
        allow read, write: if isSignedIn();

        // Read rules: owner, explicit sharedWith, admin, or public legacy docs
        allow read: if isSignedIn() && (
          (resource.data.ownerId == getUserId()) ||
          (
            resource.data.sharedWith is list && (
              (resource.data.sharedWith.size() > 0 && resource.data.sharedWith[0].userId == getUserId()) ||
              (resource.data.sharedWith.size() > 1 && resource.data.sharedWith[1].userId == getUserId()) ||
              (resource.data.sharedWith.size() > 2 && resource.data.sharedWith[2].userId == getUserId())
            )
          ) ||
          isAdminOrSuperAdmin() ||
          !(
            resource.data.ownerId is string ||
            (resource.data.sharedWith is list && resource.data.sharedWith.size() > 0)
          )
        );

        // Updates: owner or admin/super_admin
        allow update: if isSignedIn() && (
          resource.data.ownerId == getUserId() || isAdminOrSuperAdmin()
        );

        // Deletes: only super_admin
        allow delete: if isSuperAdmin();
      }

      // --- User login counters (user_logins) ---
      match /user_logins/{userId} {
        // Create/update: the user themselves or admins/super_admins
        allow create, update: if isSignedIn() && (userId == getUserId() || isAdminOrSuperAdmin());

        // Read own counters or, for admins, any
        allow read: if isSignedIn() && (userId == getUserId() || isAdminOrSuperAdmin());

        // Delete only by super_admin (cleanup)
        allow delete: if isSuperAdmin();
      }

      // --- Usernames collection - allow public read for signup availability checks ---
      match /usernames/{username} {
        // Allow anyone (including unauthenticated) to check availability
        allow get, list: if true;

        // Creation of a username document may only be performed by an authenticated user and must include uid match
        allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;

        // Only super admin may update or delete username mappings
        allow update, delete: if isSuperAdmin();
      }

      // --- Fallback: deny everything else ---
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }