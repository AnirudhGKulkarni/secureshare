rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Simple helpers
    function isSignedIn() { return request.auth != null; }

    // Presence tracking
    match /presence/{sessionId} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.sessionId == sessionId
                    && request.resource.data.lastSeen is timestamp;
      allow update: if isSignedIn()
                    && resource.data.uid == request.auth.uid
                    && request.resource.data.lastSeen is timestamp;
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow read: if isSignedIn();
    }

    // Users collection (auth users can read their own, admins may need broader reads)
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      allow read: if isSignedIn();
    }

    // Public username lookups for pre-login validation
    match /usernames/{uname} {
      allow read: if true; // required for adminSignup to verify username existence
    }

    // Admin approval documents â€” restore fast public create
    match /approval_documents/{documentId} {
      allow create: if true; // allow submissions without login
      allow read, write: if isSignedIn();
    }

    // Audit logs
    match /audit_logs/{logId} {
      allow read, write: if isSignedIn();
    }

    // Policies
    match /policies/{policyId} {
      allow read, write: if isSignedIn();
    }

    // Shared data
    match /shared_data/{dataId} {
      allow read, write: if isSignedIn();
    }

    // Fallback: authenticated only
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
