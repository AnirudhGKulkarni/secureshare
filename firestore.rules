rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserId() {
      return isSignedIn() ? request.auth.uid : null;
    }

    // Assumes each user has a role field in users/{uid}
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(getUserId())).data.role;
    }

    function isSuperAdmin() {
      return isSignedIn() && getUserRole() == 'super_admin';
    }

    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }

    function isAdminOrSuperAdmin() {
      return isAdmin() || isSuperAdmin();
    }

    // --- Users ---

    
    
    match /users/{userId} {
  allow read: if isSignedIn() && (userId == getUserId() || isAdminOrSuperAdmin());
  allow create: if isSignedIn() && request.auth.uid == userId;
  allow update: if isSignedIn() && (userId == getUserId() || isAdminOrSuperAdmin())
                && request.resource.data.diff(resource.data).changedKeys().hasOnly(['firstName','lastName','passwordUpdatedAt']);
  allow delete: if isSuperAdmin();
}




// match /users/{userId} {
//   // Creation: user can create their own profile
//   allow create: if isSignedIn() && request.auth.uid == userId;

//   // Read: owner, admins, or super admins
//   allow read: if isSignedIn() && (request.auth.uid == userId || isAdminOrSuperAdmin());

//   // Allow authenticated users to update only a small set of safe fields on their own profile.
//   // This permits toggling `loginAlerts` from the client while preventing arbitrary writes.
//   allow update: if isSignedIn()
//     && request.auth.uid == userId
//     && request.resource.data.keys().hasOnly(['firstName','lastName','company','companyDomain','domain','loginAlerts', 'passwordUpdatedAt'])
//     && (
//       !('loginAlerts' in request.resource.data) || request.resource.data.loginAlerts is bool
//     );

//   // Super admin can read/write all users
//   allow read, write: if isSuperAdmin();

//   // Admin can read all users
//   allow read: if isAdmin();
// }




    

    // --- Approval documents (if used) ---

    match /approval_documents/{docId} {
      allow create: if isSignedIn();
      allow read, update, delete: if isAdminOrSuperAdmin();
    }

    // --- Audit logs (login bar chart & recent activity) ---

    match /audit_logs/{logId} {
      // Any signed-in user can create log entries (e.g., LOGIN events)
      allow create: if isSignedIn();

      // Users can read their own logs; admins/super_admins can read all
      allow read: if isSignedIn() && (
        resource.data.userId == getUserId() || isAdminOrSuperAdmin()
      );

      // Prevent client from updating/deleting logs
      allow update, delete: if false;
    }

    // --- Alerts (dashboard alerts section) ---

    match /alerts/{alertId} {
      // Creating alerts
      allow create: if isSignedIn();

      // Reading alerts:
      // - targeted to this user (userId == uid)
      // - or global alerts (userId == 'all')
      // - or anything if admin/super_admin
      allow read: if isSignedIn() && (
        resource.data.userId == getUserId() ||
        resource.data.userId == 'all' ||
        isAdminOrSuperAdmin()
      );

      // Admins manage alerts
      allow update, delete: if isAdminOrSuperAdmin();
    }

    // --- Policies (Policies page) ---

    match /policies/{policyId} {
      allow read: if true;              // anyone can read policies
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    // --- Shared data (File Sensitivity pie chart) ---

    match /shared_data/{docId} {
      // Anyone signed in can create a shared_data record
      allow read, write: if isSignedIn();

      // Read rules:
      // - owner can read
      // - users in sharedWith array can read (sharedWith is array of maps with userId field)
      // - admins/super_admins can read all
      // - OR documents without ownerId and sharedWith (legacy/public) can be read by signed-in users
      allow read: if isSignedIn() && (
        // Owner
        (resource.data.ownerId == getUserId()) ||

        // Shared explicitly via array of maps like { userId: "..." }
        (
          resource.data.sharedWith is list &&
          (
            (resource.data.sharedWith.size() > 0 &&
             resource.data.sharedWith[0].userId == getUserId()) ||
            (resource.data.sharedWith.size() > 1 &&
             resource.data.sharedWith[1].userId == getUserId()) ||
            (resource.data.sharedWith.size() > 2 &&
             resource.data.sharedWith[2].userId == getUserId())
          )
        ) ||
        
        
        

        // Admin or super_admin
        isAdminOrSuperAdmin() ||

        // Public/legacy docs that have no explicit owner or sharedWith
        !(
          resource.data.ownerId is string ||
          (resource.data.sharedWith is list && resource.data.sharedWith.size() > 0)
        )
      );

      // Updates: owner or admin/super_admin
      allow update: if isSignedIn() && (
        resource.data.ownerId == getUserId() || isAdminOrSuperAdmin()
      );

      // Deletes: only super_admin
      allow delete: if isSuperAdmin();
    }

    // --- User login counters (user_logins) ---

    match /user_logins/{userId} {
      // Create/update:
      // - the user themselves (for client-side logging)
      // - or admins/super_admins (for maintenance)
      allow create, update: if isSignedIn() && (
        userId == getUserId() || isAdminOrSuperAdmin()
      );

      // Read own counters or, for admins, any
      allow read: if isSignedIn() && (
        userId == getUserId() || isAdminOrSuperAdmin()
      );

      // Delete only by super_admin (cleanup)
      allow delete: if isSuperAdmin();
    }
    
    
    // Usernames collection - allow public read for signup availability checks
match /usernames/{username} {
  // Allow anyone (including unauthenticated) to check availability and
  // request prefix queries for suggestions (documentId queries).
  allow get, list: if true;

  // Creation of a username document may only be performed by an
  // authenticated user and the `uid` field must match their auth uid.
  allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;

  // Only super admin may update or delete username mappings
  // to prevent malicious renames or removals.
  allow update, delete: if isSuperAdmin();
}
    

    // --- Fallback: deny everything else ---

    match /{document=**} {
      allow read, write: if false;
    }
  }
}